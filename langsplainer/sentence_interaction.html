<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Sentence Explainer</title>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #fafafa;
        }
        .input-area {
            margin-bottom: 20px;
        }
        .text-display {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            cursor: text;
        }
        .explanation {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        input[type="text"], input[type="password"] {
            padding: 8px;
            margin-top: 10px;
            box-sizing: border-box;
            width: 100%;
        }
        .toggle-button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Updated React Component -->
    <script type="text/babel" data-type="module" data-presets="env,react,typescript">
        const { useState, useEffect, useRef, StrictMode } = React;

        const SentenceExplainer = () => {
            // State variables
            const [text, setText] = useState('格拉苏蒂原创2021年新品机芯倒装手工雕花中国新年限量款偏心绿金参议员万年历。');
            const [apiKey, setApiKey] = useState('');
            const [l1Language, setL1Language] = useState('English');
            const [explanation, setExplanation] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showApiKey, setShowApiKey] = useState(false);
            const [selectedText, setSelectedText] = useState('');
            const [model, setModel] = useState('gpt-3.5-turbo'); // Use a faster model for speed
            const textDivRef = useRef(null);

            // Load API key from localStorage or URL hash on initial render
            useEffect(() => {
                // Attempt to load from localStorage
                const storedApiKey = localStorage.getItem('openai_api_key');
                if (storedApiKey) {
                    setApiKey(storedApiKey);
                } else {
                    // Fallback to URL hash
                    const hash = window.location.hash.substring(1);
                    if (hash.startsWith('apiKey=')) {
                        const key = decodeURIComponent(hash.split('=')[1]);
                        setApiKey(key);
                        localStorage.setItem('openai_api_key', key);
                    }
                }
            }, []);

            // Function to handle API key changes
            const handleApiKeyChange = (e) => {
                const value = e.target.value;
                setApiKey(value);
                localStorage.setItem('openai_api_key', value);
            };

            // Function to handle L1 language changes
            const handleL1LanguageChange = (e) => {
                setL1Language(e.target.value);
            };

            // Function to handle model selection changes
            const handleModelChange = (e) => {
                setModel(e.target.value);
            };

            // Function to toggle API key visibility
            const toggleApiKeyVisibility = () => {
                setShowApiKey(!showApiKey);
            };

            // Function to handle text input changes
            const handleTextChange = (e) => {
                setText(e.target.value);
                setExplanation(null);
            };

            // Function to handle selection changes
            useEffect(() => {
                const handleSelectionChange = () => {
                    const selection = window.getSelection();
                    if (selection && selection.rangeCount > 0) {
                        const selectedText = selection.toString().trim();
                        if (selectedText) {
                            // Check if selection is within our textDivRef
                            const anchorNode = selection.anchorNode;
                            if (textDivRef.current && textDivRef.current.contains(anchorNode)) {
                                setSelectedText(selectedText);
                            } else {
                                setSelectedText('');
                            }
                        } else {
                            setSelectedText('');
                        }
                    }
                };

                document.addEventListener('mouseup', handleSelectionChange);
                document.addEventListener('keyup', handleSelectionChange);

                return () => {
                    document.removeEventListener('mouseup', handleSelectionChange);
                    document.removeEventListener('keyup', handleSelectionChange);
                };
            }, []);

            // Debounce the API call when selectedText changes
            useEffect(() => {
                if (selectedText) {
                    setError(null);

                    if (!apiKey) {
                        setError('Please provide your OpenAI API key.');
                        return;
                    }

                    setLoading(true);
                    const delayDebounceFn = setTimeout(() => {
                        handleSubmit();
                    }, 500);

                    return () => clearTimeout(delayDebounceFn);
                } else {
                    setExplanation(null);
                    setLoading(false);
                }
            }, [selectedText]);

            // Function to handle API call
            const handleSubmit = async () => {
                try {
                    console.log('Selected text:', selectedText);

                    // Prepare the prompt
                    const prompt = `As a language assistant, please explain the following phrase in the context of the full text. Your explanation should be brief, including the pronunciation and gloss of the selected phrase. Respond only in ${l1Language}.

Full Text: ${text}
Selected Phrase: ${selectedText}`;

                    // Make the API call with the selected model
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model, // Use the selected model
                            messages: [
                                { role: 'user', content: prompt }
                            ],
                            max_tokens: 150,
                            temperature: 0.5
                        })
                    });

                    // Handle non-OK responses
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || 'API request failed.');
                    }

                    const data = await response.json();
                    console.log('API response:', data);

                    const choice = data.choices[0];
                    if (!choice) {
                        throw new Error('No choices entry in API response: ' + JSON.stringify(data));
                    }

                    const content = choice.message.content.trim();

                    setExplanation(content);

                } catch (err) {
                    console.error(err);
                    setError(err.message || 'An unexpected error occurred.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h1>Interactive Sentence Explainer</h1>
                    <p>
                        Paste your text below. Select any part of the text to get a brief explanation, including pronunciation and gloss. The explanation will appear below.
                    </p>
                    <div className="input-area">
                        <label>
                            OpenAI API Key:
                            <div style={{ position: 'relative' }}>
                                <input
                                    type={showApiKey ? 'text' : 'password'}
                                    value={apiKey}
                                    onChange={handleApiKeyChange}
                                    placeholder="Enter your API key"
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={toggleApiKeyVisibility}
                                    className="toggle-button"
                                >
                                    {showApiKey ? 'Hide' : 'Show'}
                                </button>
                            </div>
                        </label>
                        <br />
                        <label>
                            Model:
                            <select value={model} onChange={handleModelChange}>
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                <option value="gpt-4">gpt-4</option>
                            </select>
                        </label>
                        <br />
                        <label>
                            Your Native Language (L1):
                            <input
                                type="text"
                                value={l1Language}
                                onChange={handleL1LanguageChange}
                                placeholder="Enter your native language"
                                required
                            />
                        </label>
                        <br />
                        <label>
                            Paste Your Text:
                            <textarea
                                value={text}
                                onChange={handleTextChange}
                                placeholder="Paste your text here..."
                                required
                                style={{ width: '100%', height: '100px' }}
                            ></textarea>
                        </label>
                    </div>
                    <div
                        className="text-display"
                        ref={textDivRef}
                    >
                        {text}
                    </div>
                    {loading && <div>Loading explanation...</div>}
                    {error && <div className="error">Error: {error}</div>}
                    {explanation && (
                        <div className="explanation">
                            <h3>Explanation for: "{selectedText}"</h3>
                            <p>{explanation}</p>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <StrictMode>
                <SentenceExplainer />
            </StrictMode>
        );
    </script>
</body>
</html>

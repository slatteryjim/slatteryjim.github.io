<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sentence Explainer with OpenAI</title>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Optional: Include a CSS library or custom styles here -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #fafafa;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
        }
        input[type="text"], input[type="password"] {
            padding: 8px;
            margin-top: 10px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
        }
        .explanation {
            background-color: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .explanation h3 {
            margin-top: 0;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .toggle-button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Your TypeScript and JSX Code -->
    <script type="text/babel" data-type="module" data-presets="env,react,typescript">
        const { useState, useEffect, StrictMode } = React;

        const SentenceExplainer = () => {
            // State variables
            const [sentence, setSentence] = useState('格拉苏蒂原创2021年新品机芯倒装手工雕花中国新年限量款偏心绿金参议员万年历。');
            const [apiKey, setApiKey] = useState('');
            const [l1Language, setL1Language] = useState('English');
            const [explanation, setExplanation] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showApiKey, setShowApiKey] = useState(false);
            const [model, setModel] = useState('gpt-4o-mini'); // Default model

            // Load API key from localStorage or URL hash on initial render
            useEffect(() => {
                // Attempt to load from localStorage
                const storedApiKey = localStorage.getItem('openai_api_key');
                if (storedApiKey) {
                    setApiKey(storedApiKey);
                } else {
                    // Fallback to URL hash
                    const hash = window.location.hash.substring(1);
                    if (hash.startsWith('apiKey=')) {
                        const key = decodeURIComponent(hash.split('=')[1]);
                        setApiKey(key);
                        localStorage.setItem('openai_api_key', key);
                    }
                }
            }, []);

            // Function to handle API key changes
            const handleApiKeyChange = (e) => {
                const value = e.target.value;
                setApiKey(value);
                localStorage.setItem('openai_api_key', value);
            };

            // Function to handle L1 language changes
            const handleL1LanguageChange = (e) => {
                setL1Language(e.target.value);
            };

            // Function to handle model selection changes
            const handleModelChange = (e) => {
                setModel(e.target.value);
            };

            // Function to toggle API key visibility
            const toggleApiKeyVisibility = () => {
                setShowApiKey(!showApiKey);
            };

            // Function to handle form submission
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);

                if (!apiKey) {
                    setError('Please provide your OpenAI API key.');
                    return;
                }

                if (!sentence.trim()) {
                    setError('Please enter a sentence to process.');
                    return;
                }

                setLoading(true);

                try {
                    console.log('Input sentence:', sentence);

                    const maxOutputTokens = 16384; // max output tokens currently supported by gpt-4o-mini

                    // Prepare the prompt
                    // TODO: should include an example sentence and exampel output in the prompt? Though it is getting big, of course.
                    const prompt = `You are a language sentence explainer.
As a language mentor and fluent speaker of their target language (L2), you **only reply in that language** except when providing translations. You are very encouraging of them to succeed in their studies.

The user was reading some text and came across a sentence they didn't understand. Maybe they didn't understand one word or phrase, or maybe they knew each word but didn't understand what the sentence as a whole meant.
You can identify the language they are studying by analyzing the sentence they provide.

<example>
    <exampleInputs>
        <usersNativeLanguage>English</usersNativeLanguage>
        <sentenceBeingStudied>国央企如此热切拥抱大模型，或与一道新政有关。</sentenceBeingStudied>
    </exampleInputs>
    You would reply with this JSON:
    <exampleResponse>
        {
            "sentenceOriginal": "国央企如此热切拥抱大模型，或与一道新政有关。",
            "languageBeingLearned": "中文",
            "usersNativeLanguage": "English",
            "sentenceSimplified": "State-owned enterprises in the country are eager to embrace large models, possibly related to a new policy.",
            "sentenceSimplifiedGreatly": "The state companies really want to use big models, maybe because of a new rule.",
            "sentenceTranslation": "State-owned enterprises are so eager to embrace large models, which may be related to a new policy.",
            "sentenceTranslationLiteral": "National central enterprises so eagerly embrace big models, possibly related to a new policy.",
            "sentenceSegmentedBreakdown": [
                {
                    "wordOrPhrase": "国央企",
                    "pronunciation": "guó yāng qǐ",
                    "gloss": "国家企业",
                    "explanation": "指的是国家的中央企业。",
                    "glossTranslation": "state-owned enterprises",
                    "explanationTranslation": "Refers to central enterprises of the state."
                },
                {
                    "wordOrPhrase": "如此",
                    "pronunciation": "rúcǐ",
                    "gloss": "如此大量",
                    "explanation": "表示程度很高或非常。",
                    "glossTranslation": "so; such",
                    "explanationTranslation": "Indicates a high degree or very."
                },
                {
                    "wordOrPhrase": "热切",
                    "pronunciation": "rèqiè",
                    "gloss": "热情",
                    "explanation": "指的是非常渴望或热衷。",
                    "glossTranslation": "eager; passionate",
                    "explanationTranslation": "Means very eager or enthusiastic."
                },
                {
                    "wordOrPhrase": "拥抱",
                    "pronunciation": "yōngbào",
                    "gloss": "接受",
                    "explanation": "在这里比喻接受或采纳。",
                    "glossTranslation": "embrace; hug",
                    "explanationTranslation": "Metaphorically means to accept or adopt."
                },
                {
                    "wordOrPhrase": "大模型",
                    "pronunciation": "dà móxíng",
                    "gloss": "大型模型",
                    "explanation": "指的是大型的模型或系统。",
                    "glossTranslation": "large model",
                    "explanationTranslation": "Refers to large models or systems."
                },
                {
                    "wordOrPhrase": "或与",
                    "pronunciation": "huò yǔ",
                    "gloss": "或与相关",
                    "explanation": "表示可能的关联。",
                    "glossTranslation": "or related to",
                    "explanationTranslation": "Indicates a possible relation."
                },
                {
                    "wordOrPhrase": "一道新政",
                    "pronunciation": "yīdào xīng zhèng",
                    "gloss": "新的政策",
                    "explanation": "指的是新的政策或法规。",
                    "glossTranslation": "a new policy",
                    "explanationTranslation": "Refers to a new policy or regulation."
                }
            ],
            "sentenceCommentsOrWarnings": "这个句子的结构比较复杂，涉及一些专业术语，所以理解起来可能有点困难，但很棒的是你在努力学习！",
            "sentenceRecommendedVersion": "国家央企如此热切拥抱大型模型，这可能与新政策有关。"
        }
    </exampleResponse>
</example>

Now, here are your inputs for this case:
<usersNativeLanguage>${l1Language}</usersNativeLanguage>
<sentenceBeingStudied>${sentence}</sentenceBeingStudied>`;

                    // TODO: use special tokens to demarcate the sentence, 
                    // and also prevent the template variables from using these special tokens!

                    // Make the API call with the selected model
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model, // Use the selected model
                            messages: [
                                { role: 'user', content: prompt }
                            ],
                            response_format: {
                                "type": "json_schema",
                                "json_schema": {
                                    "name": "sentence_explanation",
                                    "strict": true,
                                    "schema": {
                                        "type": "object",
                                        "properties": {
                                            "sentenceOriginal": {
                                                "type": "string",
                                                "description": "The original sentence provided by the user."
                                            },
                                            "languageBeingLearned": {
                                                "type": "string",
                                                "description": "The detected language of the sentence the user is reading (L2)."
                                            },
                                            "usersNativeLanguage": {
                                                "type": "string",
                                                "description": "The native language of the user (L1), used for translations."
                                            },
                                            "sentenceSimplified": {
                                                "type": "string",
                                                "description": "A simplified version of the sentence using easy-to-understand vocabulary while retaining the original nuances."
                                            },
                                            "sentenceSimplifiedGreatly": {
                                                "type": "string",
                                                "description": "An even more simplified version of the sentence, focusing on basic vocabulary and structure, but still maintaining the original meaning."
                                            },
                                            "sentenceTranslation": {
                                                "type": "string",
                                                "description": "A clear translation of the sentence in the usersNativeLanguage."
                                            },
                                            "sentenceTranslationLiteral": {
                                                "type": "string",
                                                "description": "A word-for-word translation of the sentence into the usersNativeLanguage that closely follows the structure and grammar of the original sentence."
                                            },
                                            "sentenceSegmentedBreakdown": {
                                                "type": "array",
                                                "items": {
                                                    "type": "object",
                                                    "properties": {
                                                        "wordOrPhrase":  {"type": "string",  "description": "The word or phrase from the sentence."},
                                                        "pronunciation": {"type": "string", "description": "The accurate pronunciation of the word or phrase (e.g., pinyin, IPA)."},
                                                        "gloss":       {"type": "string", "description": "A short definition or gloss in the languageBeingLearned."},
                                                        "explanation": {"type": "string", "description": "An explanatory alternative in the languageBeingLearned."},
                                                        "glossTranslation": {"type": "string", "description": "A short definition or gloss in the usersNativeLanguage."},
                                                        "explanationTranslation": {"type": "string", "description": "An explanatory alternative in the usersNativeLanguage."}
                                                    },
                                                    "required": [
                                                        "wordOrPhrase",
                                                        "pronunciation",
                                                        "gloss",
                                                        "glossTranslation",
                                                        "explanation",
                                                        "explanationTranslation"
                                                    ],
                                                    "additionalProperties": false
                                                }
                                            },
                                            "sentenceCommentsOrWarnings": {"type": "string", "description": "Any comments or warnings about the sentence."},
                                            "sentenceRecommendedVersion": {"type": "string", "description": "The recommended version of the sentence, applying any improvements deemed appropriate."}
                                        },
                                        "required": [
                                            "sentenceOriginal",
                                            "languageBeingLearned",
                                            "usersNativeLanguage",
                                            "sentenceSimplified",
                                            "sentenceSimplifiedGreatly",
                                            "sentenceTranslation",
                                            "sentenceTranslationLiteral",
                                            "sentenceSegmentedBreakdown",
                                            "sentenceCommentsOrWarnings",
                                            "sentenceRecommendedVersion"
                                        ],
                                        "additionalProperties": false
                                    }
                                }
                            },
                            max_tokens: maxOutputTokens,
                            temperature: 0
                        })
                    });

                    // Handle non-OK responses
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || 'API request failed.');
                    }

                    const data = await response.json();
                    console.log('API response:', data);

                    const choice = data.choices[0];
                    if (!choice) {
                        throw new Error('No choices entry in API response: ' + JSON.stringify(data));
                    }
                    if (choice.finish_reason !== 'stop') {
                        throw new Error('Model did not finish processing, finish_reason: ' + choice.finish_reason);
                    }

                    const content = choice.message.content;

                    let explanationData;
                    try {
                        explanationData = JSON.parse(content);
                    } catch (parseError) {
                        throw new Error('Failed to parse JSON response: ' + parseError.message);
                    }

                    console.log('Parsed explanation data:', explanationData);
                    setExplanation(explanationData);

                } catch (err) {
                    console.error(err);
                    setError(err.message || 'An unexpected error occurred.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h1>Sentence Explainer</h1>
                    <p>
                        This tool allows you to input a sentence in your target language and receive detailed explanations to aid in your language learning.<br />
                        First, provide your OpenAI API key, either through the text input field or URL hash (it will also be stored in the browser local storage for convenience).<br />
                        Enter the sentence you want to understand and click "Explain Sentence". The tool will send a prompt to OpenAI's API to generate detailed explanations.<br />
                        The returned explanations are displayed below.
                    </p>
                    <form onSubmit={handleSubmit}>
                        <label>
                            OpenAI API Key:
                            <div style={{ position: 'relative' }}>
                                <input
                                    type={showApiKey ? 'text' : 'password'}
                                    value={apiKey}
                                    onChange={handleApiKeyChange}
                                    placeholder="Enter your API key"
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={toggleApiKeyVisibility}
                                    className="toggle-button"
                                >
                                    {showApiKey ? 'Hide' : 'Show'}
                                </button>
                            </div>
                        </label>
                        <br />
                        <label>
                            Model:
                            <select value={model} onChange={handleModelChange}>
                                <option value="gpt-4o-mini">gpt-4o-mini</option>
                                <option value="gpt-4o">gpt-4o</option>
                            </select>
                        </label>
                        <br />
                        <label>
                            Your Native Language (L1):
                            <input
                                type="text"
                                value={l1Language}
                                onChange={handleL1LanguageChange}
                                placeholder="Enter your native language"
                                required
                            />
                        </label>
                        <br />
                        <label>
                            Enter Sentence:
                            <textarea
                                value={sentence}
                                onChange={(e) => setSentence(e.target.value)}
                                placeholder="Paste your sentence here..."
                                required
                            ></textarea>
                        </label>
                        <br />
                        <button type="submit" disabled={loading}>
                            {loading ? 'Processing...' : 'Explain Sentence'}
                        </button>
                    </form>
                    {error && <div className="error">Error: {error}</div>}
                    {explanation && (
                        <div>
                            <h2>Explanation:</h2>
                            <div className="explanation">
                                <h3>Sentence Original (detected as {explanation.languageBeingLearned}):</h3>
                                <p>{explanation.sentenceOriginal}</p>

                                <h3>Sentence Simplified:</h3>
                                <p>{explanation.sentenceSimplified}</p>

                                <h3>Sentence Greatly Simplified:</h3>
                                <p>{explanation.sentenceSimplifiedGreatly}</p>

                                <h3>Sentence Translation (into {explanation.usersNativeLanguage}):</h3>
                                <p>{explanation.sentenceTranslation}</p>

                                <h3>Sentence Literal Translation:</h3>
                                <p>{explanation.sentenceTranslationLiteral}</p>

                                <h3>Sentence Segmented Breakdown:</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Word or Phrase</th>
                                            <th>Pronunciation</th>
                                            <th>Gloss</th>
                                            <th>Explanation</th>
                                            <th>Gloss ({l1Language})</th>
                                            <th>Explanation ({l1Language})</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {explanation.sentenceSegmentedBreakdown.map((item, index) => (
                                            <tr key={index}>
                                                <td><strong>{item.wordOrPhrase}</strong></td>
                                                <td>{item.pronunciation}</td>
                                                <td>{item.gloss}</td>
                                                <td>{item.explanation}</td>
                                                <td>{item.glossTranslation}</td>
                                                <td>{item.explanationTranslation}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>

                                <h3>Comments or Warnings:</h3>
                                <p>{explanation.sentenceCommentsOrWarnings}</p>

                                <h3>Recommended Version:</h3>
                                <p>{explanation.sentenceRecommendedVersion}</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <StrictMode>
                <SentenceExplainer />
            </StrictMode>
        );
    </script>
</body>
</html>
